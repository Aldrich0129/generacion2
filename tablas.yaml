# Definición de las tablas asociadas a marcadores de la plantilla

tables:

  # -----------------------------------------------------------
  # 1. Análisis indirecto global (TNMM)
  # -----------------------------------------------------------
  analisis_indirecto_global:
    marker: "<<Tabla análisis indirecto>>"
    title: "Análisis indirecto TNMM"
    ui_component: "single_row_grid"
    remove_empty_rows: false
    columns:
      - id: min
        header: "Min"
        type: "percent"
        editable: true
      - id: lq
        header: "LQ"
        type: "percent"
        editable: true
      - id: med
        header: "Med"
        type: "percent"
        editable: true
      - id: uq
        header: "UQ"
        type: "percent"
        editable: true
      - id: max
        header: "Max"
        type: "percent"
        editable: true
    rows:
      - id: rango_tnmm
        label: "Rango TNMM"
        editable: true

  # -----------------------------------------------------------
  # 2. Tablas por operación (TNMM por operación)
  #    Marcador con patrón: <<Tabla Operación 1>>, <<Tabla Operación 2>>, etc.
  # -----------------------------------------------------------
  analisis_indirecto_operacion:
    marker_pattern: "<<Tabla Operación {n}>>"
    title: "Análisis TNMM por operación"
    ui_component: "single_row_grid"
    parameters:
      n:
        type: integer
        min: 1
        max: 10          # se puede ampliar si hay más operaciones
    columns:
      - id: min
        header: "Min"
        type: "percent"
        editable: true
      - id: lq
        header: "LQ"
        type: "percent"
        editable: true
      - id: med
        header: "Med"
        type: "percent"
        editable: true
      - id: uq
        header: "UQ"
        type: "percent"
        editable: true
      - id: max
        header: "Max"
        type: "percent"
        editable: true
    rows:
      - id: rango_operacion
        label_from: "nombre_operacion"   # se puede usar el nombre de la operación (Servicios de soporte, etc.)
        editable: true

  # -----------------------------------------------------------
  # 3. Tabla de partidas contables
  # -----------------------------------------------------------
  partidas_contables:
    marker: "<<Tabla partidas contables>>"
    title: "Partidas contables y márgenes"
    ui_component: "grid"
    remove_empty_rows: false
    dynamic_headers:
      ejercicio_actual_var: "<<Ejercicio completo>>"
      ejercicio_anterior_var: "ejercicio_anterior"   # variable que pedirá la UI
    columns:
      - id: partida
        header: "Partidas Contables"
        type: "text"
        editable: false
      - id: ejercicio_actual
        header_template: "Ejercicio {ejercicio_actual}"
        type: "number"
        editable: true
      - id: ejercicio_anterior
        header_template: "Ejercicio {ejercicio_anterior}"
        type: "number"
        editable: true
      - id: variacion
        header_template: "Variación {ejercicio_actual}-{ejercicio_anterior} (%)"
        type: "percent"
        editable: false
        formula: "(ejercicio_actual - ejercicio_anterior) / ejercicio_anterior * 100"
    rows:
      - id: cifra_negocios
        label: "Cifra de negocios"
        input_mode: "manual"
        calculate_variacion: true
      - id: total_costes_operativos
        label: "Total costes operativos"
        input_mode: "manual"
        calculate_variacion: true
      - id: ebit
        label: "EBIT"
        input_mode: "manual"
        calculate_variacion: true
      - id: resultado_financiero
        label: "Resultado Financiero"
        input_mode: "manual"
        calculate_variacion: true
      - id: ebt
        label: "EBT"
        input_mode: "manual"
        calculate_variacion: true
      - id: resultado_neto
        label: "Resultado Neto"
        input_mode: "manual"
        calculate_variacion: true
      - id: operating_margin_om
        label: "Operating Margin (OM)"
        input_mode: "calculated"
        ejercicio_actual_formula: "ebit.ejercicio_actual / cifra_negocios.ejercicio_actual"
        ejercicio_anterior_formula: "ebit.ejercicio_anterior / cifra_negocios.ejercicio_anterior"
        calculate_variacion: true
      - id: net_cost_plus_ncp
        label: "Net Cost Plus (NCP)"
        input_mode: "calculated"
        ejercicio_actual_formula: "ebit.ejercicio_actual / total_costes_operativos.ejercicio_actual"
        ejercicio_anterior_formula: "ebit.ejercicio_anterior / total_costes_operativos.ejercicio_anterior"
        calculate_variacion: true

  # -----------------------------------------------------------
  # 4. Tabla de operaciones vinculadas
  # -----------------------------------------------------------
  operaciones_vinculadas:
    marker: "<<Tabla operaciones vinculadas>>"
    title: "Operaciones vinculadas"
    ui_component: "grid_dynamic_rows"
    remove_empty_rows: true
    columns:
      - id: tipo_operacion
        header: "Tipo de operación vinculada"
        type: "text"
        editable: true
      - id: entidad_vinculada
        header: "Entidad vinculada"
        type: "text"
        editable: true
      - id: ingreso_local_file
        header: "Ingreso - Importe Local File (EUR)"
        type: "number"
        editable: true
      - id: gasto_local_file
        header: "Gasto - Importe Local File (EUR)"
        type: "number"
        editable: true
    footer_rows:
      - id: total
        label: "Total"
        row_type: "sum"
        sum_columns: ["ingreso_local_file", "gasto_local_file"]
      - id: pesos
        label: "Pesos"
        row_type: "percent_of_total"   # la lógica se puede implementar en Python

  # -----------------------------------------------------------
  # 5. Tablas de cumplimiento inicial (resumen)
  #    Local File y Master File – misma estructura
  # -----------------------------------------------------------
  cumplimiento_inicial_LF:
    marker: "<<Tabla inicial formal LF>>"
    title: "Cumplimiento formal – Local File (resumen)"
    ui_component: "grid"
    columns:
      - id: numero
        header: "#"
        type: "integer"
        editable: false
      - id: seccion
        header: "Secciones (Artículo 16 del Reglamento)"
        type: "text"
        editable: false
      - id: cumplimiento
        header: "Cumplimiento"
        type: "choice"
        editable: true
        options: ["Sí", "No", "Ver comentario"]

  cumplimiento_inicial_MF:
    marker: "<<Tabla inicial formal MF>>"
    title: "Cumplimiento formal – Master File (resumen)"
    ui_component: "grid"
    columns:
      - id: numero
        header: "#"
        type: "integer"
        editable: false
      - id: seccion
        header: "Secciones (Artículo 15 del Reglamento)"
        type: "text"
        editable: false
      - id: cumplimiento
        header: "Cumplimiento"
        type: "choice"
        editable: true
        options: ["Sí", "No", "Ver comentario"]

  # -----------------------------------------------------------
  # 6. Tablas de cumplimiento formal en detalle
  # -----------------------------------------------------------
  cumplimiento_formal_LF:
    marker: "<<Tabla de cumplimiento formal LF>>"
    title: "Cumplimiento formal detallado – Local File"
    ui_component: "grid"
    columns:
      - id: requisito
        header: "Requisito (art. 16 RIS)"
        type: "text"
        editable: false
      - id: cumplimiento
        header: "Cumplimiento"
        type: "choice"
        editable: true
        options: ["Sí", "No", "Ver comentario"]
      - id: comentario
        header: "Comentario"
        type: "text"
        editable: true
        conditional_on:
          field: "cumplimiento"
          value: "Ver comentario"

  cumplimiento_formal_MF:
    marker: "<<Tabla de cumplimiento formal MF>>"
    title: "Cumplimiento formal detallado – Master File"
    ui_component: "grid"
    columns:
      - id: requisito
        header: "Secciones (Artículo 15 del Reglamento)"
        type: "text"
        editable: false
      - id: cumplimiento
        header: "Cumplimiento"
        type: "choice"
        editable: true
        options: ["Sí", "No", "Ver comentario"]
      - id: comentario
        header: "Comentario"
        type: "text"
        editable: true
        conditional_on:
          field: "cumplimiento"
          value: "Ver comentario"

  # -----------------------------------------------------------
  # 7. Tabla de riesgos
  # -----------------------------------------------------------
  riesgos_pt:
    marker: "<<Tabla de riesgos>>"
    title: "Revisión de elementos de riesgo en materia de precios de transferencia"
    ui_component: "grid"
    remove_empty_rows: false
    columns:
      - id: numero
        header: "#"
        type: "integer"
        editable: false
      - id: elemento_riesgo
        header: "Elementos de riesgo en materia fiscal"
        type: "text"
        editable: false
      - id: impacto_compania
        header: "Impacto en Compañía Ejercicio"
        type: "choice"
        editable: true
        options: ["Sí", "No", "Posible"]
      - id: nivel_afectacion_preliminar
        header: "Nivel de Afectación Preliminar"
        type: "choice"
        editable: true
        options: ["Sí", "No", "Posible"]
      - id: mitigadores
        header: "Mitigadores de Riesgo Aplicados"
        type: "text"
        editable: true
      - id: nivel_afectacion_final
        header: "Nivel de Afectación Final"
        type: "choice"
        editable: true
        options: ["Sí", "No", "Posible"]
